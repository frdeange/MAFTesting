name: Deploy Agents to Azure AI Foundry

on:
  push:
    branches: [main]
    paths:
      - 'agents/*.yaml'
  pull_request:
    paths:
      - 'agents/*.yaml'
  workflow_dispatch:
    inputs:
      agent_file:
        description: 'Agent YAML file to deploy'
        required: true
        default: 'agents/mslearnagent.yaml'

jobs:
  validate:
    name: Validate YAML Schema
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python 3.12
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      
      - name: Install PyYAML
        run: pip install pyyaml
      
      - name: Validate YAML Schema
        run: |
          for yaml_file in agents/*.yaml; do
            echo "Validating $yaml_file..."
            python scripts/validate_yaml.py "$yaml_file"
          done

  deploy:
    name: Deploy to Azure AI Foundry
    needs: validate
    runs-on: ubuntu-latest
    # Solo deploy en push a main o workflow_dispatch
    if: github.event_name != 'pull_request'
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python 3.12
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      
      - name: Install .NET (for PowerFx)
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.x'
      
      - name: Install dependencies
        run: pip install -r requirements.txt
      
      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}
      
      - name: Deploy Agent(s)
        env:
          AZURE_FOUNDRY_PROJECT_ENDPOINT: ${{ secrets.AZURE_FOUNDRY_PROJECT_ENDPOINT }}
          AZURE_FOUNDRY_PROJECT_MODEL_ID: ${{ secrets.AZURE_FOUNDRY_PROJECT_MODEL_ID }}
          APPLICATIONINSIGHTS_CONNECTION_STRING: ${{ secrets.APPLICATIONINSIGHTS_CONNECTION_STRING }}
          OTEL_TRACES_EXPORTER: none
          OTEL_METRICS_EXPORTER: none
          OTEL_LOGS_EXPORTER: none
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            # Deploy specific file from manual trigger
            python scripts/deploy_agent.py "${{ inputs.agent_file }}"
          else
            # Deploy all changed YAML files
            for yaml_file in agents/*.yaml; do
              echo "Deploying $yaml_file..."
              python scripts/deploy_agent.py "$yaml_file"
            done
          fi
